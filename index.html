<html>
<head>
<title>AudioPlay</title>
</head>
<body>
<div id="keys"></div>
<br>
<input type="range" min="0" max="1" step="0.05" value="0.25" id="volume-input" />
<script>

const concertPitch = 440; // Note 49, A4, 440 Hz
const concertPitchNum = 48; // (0 index)
const sharps = [false, true, false, false, true, false, true, false, false, true, false, true];
const noteRatio = Math.exp(Math.LN2 / 12);

const keysDiv = document.getElementById('keys');
for (let i = 0; i < 96; i++) {
    const btn = document.createElement('button');
    const num = i;
    btn.innerText = getNoteName(num);
    btn.addEventListener('click', function (e){
        playNote(getNoteFreq(num));
        console.log(getNoteName(num));
    });
    keysDiv.appendChild(btn);

    if(num % 12 == 11) {
        keysDiv.appendChild(document.createElement('br'));
    }
}

function getNoteFreq (num) {
    return concertPitch * Math.pow(noteRatio, num - concertPitchNum);
}

function getNoteName (num) {
    const mod = num % 12;
    const alpha = 'AABCCDDEFFGG'[mod];
    const sharp = sharps[mod] ? 'â™¯' : '';
    const octave = Math.floor(num/12) + ((alpha === "A" || alpha === "B") ? 0 : 1);
    return alpha + sharp + octave;
}

for(const btn of document.getElementsByClassName('play-btn')) {
}

document.getElementById('volume-input').addEventListener('change', function (e) {
	if (gainNode) {
		gainNode.gain.linearRampToValueAtTime(e.target.value, audioCtx.currentTime + 1);
	}
});

document.addEventListener('keydown', function (e) {
    const keyMap = '1234567890-=qwertyuiop[]\\asdfghjkl;\'zxcvbnm,./ `';
    const noteNum = keyMap.indexOf(e.key);
    if (noteNum >= 0) {
        playNoteNum(noteNum + 24);
        console.log(getNoteName(noteNum + 24));
    }
});

function playNoteNum(num) {
    return playNote(getNoteFreq(num));
}

let audioCtx, gainNode;
function playNote (freq) {
	if (!audioCtx) {
		audioCtx = new (window.AudioContext || window.webkitAudioContext)();
		gainNode = audioCtx.createGain();

		gainNode.gain.setValueAtTime(0.25, 0);

		gainNode.connect(audioCtx.destination);
	}

	const duration = 1;
	const chord = false;

	// Create an empty three-second stereo buffer at the sample rate of the AudioContext
	var myArrayBuffer = audioCtx.createBuffer(2, audioCtx.sampleRate * duration, audioCtx.sampleRate);

	// Fill the buffer with white noise;
	// just random values between -1.0 and 1.0
	for (var channel = 0; channel < myArrayBuffer.numberOfChannels; channel++) {
	  // This gives us the actual array that contains the data
	  var nowBuffering = myArrayBuffer.getChannelData(channel);
	  for (var i = 0; i < myArrayBuffer.length; i++) {
		// Math.random() is in [0; 1.0]
		// audio needs to be in [-1.0; 1.0]

		let baseValue;
		if (chord) {
			baseValue = average(tone(freq, i), tone(freq*2, i), tone(freq*4, i));
		} else {
			baseValue = tone(freq, i);
		}

		nowBuffering[i] =  baseValue * Math.abs(Math.sin(i * ((1/duration) / audioCtx.sampleRate) * Math.PI));
	  }
	}

	// Get an AudioBufferSourceNode.
	// This is the AudioNode to use when we want to play an AudioBuffer
	var source = audioCtx.createBufferSource();

	// set the buffer in the AudioBufferSourceNode
	source.buffer = myArrayBuffer;

	// connect the AudioBufferSourceNode to the
	// destination so we can hear the sound
	source.connect(gainNode);

	// start the source playing
	source.start();

	function tone (freq, i) {
		return Math.sin(i * (freq / audioCtx.sampleRate) * Math.PI * 2);
	}

	function average() {
		return Array.prototype.reduce.call(arguments, (a,b) => a + b, 0) / arguments.length;
	}
}
</script>
</body>
</html>
